(function(){meddb={};var e={static_base_url:"",data_base_url:"",loader:"standard"};(function(t){d3.json(t,function(t){e=t})})("meddb.json");var t=function(e,t){e.slice(-5)==".html"?d3.html(e,t):d3.json(e,t)},n=function(t,n){var r;t.slice(-5)==".html"?(r=[e.static_base_url+t.slice(0,-5)+".jsonp"],meddb.callback=function(e){var t=document.createDocumentFragment(),r=document.createElement("div");r.innerHTML=e,t.appendChild(r.firstChild),n(t)}):(r=[e.data_base_url+t+"?jsonp=meddb.callback"],meddb.callback=function(e){n(e)}),d3.select("html body").select("script#meddb_jsonp").remove(),d3.select("html body").select("script#meddb_jsonp").data(r).enter().append("script").attr("id","meddb_jsonp").attr("src",function(e){return e})},r=function(r,i){e.loader=="standard"?t(r,i):e.loader=="jsonp"&&n(r,i)};meddb.template={},meddb.template.cache={},meddb.template.load=function(e,t){d3.html(e,function(e){t(e)})},meddb.template.inject=function(e,t){t=t||"#meddb_inner_container";var n=d3.select(t)[0][0];n.innerHTML="",n.appendChild(e)},meddb.template.hide=function(){d3.select("#meddb_page").attr("id","meddb_page_outgoing").transition().style("opacity","0").style("left","-950px").remove(),d3.select("img#meddb_loading").transition().duration(100).style("opacity",1)},meddb.template.show=function(e){var t="#meddb_inner_container";d3.select(e).select(".meddb_inner_page").attr("id","meddb_page_incoming").style("opacity","0").style("left","950px");var n=d3.select(t)[0][0];n.appendChild(e);var r=d3.select("#meddb_page_incoming")[0][0].clientHeight;d3.select("#meddb_page_incoming").transition().style("opacity","1").style("left","0px").attr("id","meddb_page"),d3.select("img#meddb_loading").transition().duration(100).style("opacity",0),d3.select("#meddb_inner_container").transition().style("height",r+"px")},meddb.template.replace=function(e){var t="#meddb_inner_container";d3.select("#meddb_page").attr("id","meddb_page_outgoing").transition().style("opacity","0").remove(),d3.select(e).select(".meddb_inner_page").attr("id","meddb_page_incoming").style("opacity","0").style("left","0px");var n=d3.select(t)[0][0];n.appendChild(e);var r=d3.select("#meddb_page_incoming")[0][0].clientHeight;d3.select("#meddb_page_incoming").transition().style("opacity","1").attr("id","meddb_page"),d3.select("img#meddb_loading").transition().duration(100).style("opacity",0),d3.select("#meddb_inner_container").transition().style("height",r+"px")},meddb.template.fx=function(e){var t="#meddb_inner_container";d3.select(e).select(".meddb_inner_page").attr("id","meddb_page_incoming").style("opacity","0").style("left","950px");var n=d3.select(t)[0][0];n.appendChild(e),d3.select("#meddb_page").attr("id","meddb_page_outgoing").transition().style("opacity","0").style("left","-950px").remove(),d3.select("#meddb_page_incoming").transition().style("opacity","1").style("left","0px").attr("id","meddb_page")},meddb.router=function(){var e=location.hash,t=meddb.history.list[meddb.history.list.length-1];if(t&&e==t.hash)return;if(e==""||e=="#")location.hash="medicine";else if(e.substring(0,5)=="#tab:"){var n=e.substring(5);meddb.tabber.change(n)}else{var r="";if(e=="#medicine")meddb.medicine.list();else if(e.substring(0,10)=="#medicine:"){var i=parseInt(e.substring(10));meddb.medicine.detail(i)}else if(e.substring(0,9)=="#product:"){var i=parseInt(e.substring(9));meddb.product.detail(i)}else if(e.substring(0,10)=="#supplier:"){var i=parseInt(e.substring(10));meddb.supplier.detail(i)}else if(e.substring(0,13)=="#procurement:"){var i=parseInt(e.substring(13));meddb.procurement.detail(i)}else if(e.substring(0,5)=="#tab:"){var n=e.substring(5);d3.select("div#meddb_inner_container").select("div.tab-content").selectAll("div.tab-pane").classed("active",!1),d3.select("div#meddb_inner_container").select("div.tab-content").select("div.tab-pane#"+n).classed("active",!0)}}},meddb.history={},meddb.history.list=[],meddb.history.add=function(e,t){var n=meddb.history.list[meddb.history.list.length-1];if(n&&e==n.hash)return;meddb.history.list.push({hash:e,text:t}),d3.select("ul#meddb_breadcrumb").selectAll("li").remove();var r=d3.select("ul#meddb_breadcrumb").selectAll("li").data(meddb.history.list.slice(-5)).enter().append("li");r.append("a").attr("href",function(e){return e.hash}).text(function(e){return e.text}),r.append("span").classed("divider",!0).text(" / ")},meddb.tabber={},meddb.tabber.init=function(){var e=function(){return meddb.tabber.change(this.href.split("#tab:")[1]),!1};d3.selectAll('a[href^="#tab:"]').on("click",e)},meddb.tabber.onclick=function(e){return meddb.tabber.change(e.href.split("#tab:")[1]),e.parentNode.className+=" active",!1},meddb.tabber.change=function(e){d3.select("div#meddb_inner_container").select("div.tab-content").selectAll("div.tab-pane").classed("active",!1),d3.select("div#meddb_inner_container").select("div.tab-content").select("div.tab-pane#"+e).classed("active",!0),d3.select("div#meddb_inner_container").select("ul.nav.nav-tabs").selectAll("li").classed("active",!1),d3.select("div#meddb_inner_container").select("ul.nav.nav-tabs").select('li>a[href="#tab:'+e+'"]').classed("active",!0)},meddb.medicine={};var s=function(e,t){var n=function(e){var t=[],n=[],r=[];return e.ingredients.forEach(function(e){n.push(e.inn),r.push(e.strength)}),t.push(e.name||n.join(" + ")),t.push(r.join(" + ")),t.push(e.dosageform.name),t.push(d3.round(e.avgprice,4)),t.push(d3.round(e.mshprice,4)||""),t},r=function(e,t){var n=[],r=[];return e.ingredients.forEach(function(e){n.push(e.inn)}),t.ingredients.forEach(function(e){r.push(e.inn)}),a_sort=e.name||n.join(" + "),b_sort=t.name||r.join(" + "),a_sort>b_sort?1:b_sort>a_sort?-1:0},i=d3.select(t).select("#meddb_medicine_list").select("tbody");i.selectAll("tr").remove();var s=i.selectAll("tr").data(e.sort(r)).enter().append("tr").style("cursor","pointer").on("click",function(e){location.hash="medicine:"+e.id});s.selectAll("td").data(n).enter().append("td").text(function(e){return e})};meddb.medicine.data={},meddb.medicine.list=function(){meddb.template.hide(),r("/medicine_list.html",function(e){r("/json/medicine/",function(t){meddb.medicine.data=t,s(t,e),meddb.history.add(location.hash,"All Medicine"),meddb.template.show(e),d3.select("#meddb_medicine_search").on("keyup",function(){meddb.medicine.filter(this.value)})})})},meddb.medicine.filter=function(e){var t=[];meddb.medicine.data.forEach(function(n){var r=0;n.ingredients.forEach(function(t){var n=t.inn.toLowerCase();n.indexOf(e.toLowerCase())!=-1&&r++}),r>0&&t.push(n)}),s(t,d3.select("div.meddb_inner_page")[0][0])},render_pack=function(e){return e.container.quantity+" "+e.container.unit+" ("+e.container.type+")"},meddb.medicine.detail=function(e,t,n,s){s!=1&&meddb.template.hide(),t==undefined&&(t="country"),n==undefined&&(n=!1),r("/medicine_detail.html",function(o){r("/json/medicine/"+e+"/",function(r){var u=function(){var e=[];return r.ingredients.forEach(function(t){e.push(t.inn+" "+t.strength)}),e.join(" + ")},a=function(e){var t=[],n="procurement:"+e.id;t.push({text:e.country.name,hash:n});var i=d3.round(e.price_per_unit,4);return typeof i=="number"?t.push({text:i,hash:n}):t.push({text:"(Not Available)",hash:n}),t.push({text:d3.round(e.price_usd,4),hash:n}),typeof i=="number"?t.push({text:d3.round(i/r.mshprice,4),hash:n}):t.push({text:"(Not Available)",hash:n}),t.push({text:e.incoterm.name||"(Not Available)",hash:n}),t.push({text:render_pack(e),hash:n}),t.push({text:e.volume||"(Not Available)",hash:n}),e.start_date&&e.end_date?t.push({text:e.start_date+" to "+e.end_date,hash:n}):e.start_date?t.push({text:"From "+e.start_date,hash:n}):e.end_date?t.push({text:"Until "+e.end_date,hash:n}):t.push({text:"(Not Available)",hash:n}),t},f=function(e,r){var i="",s="";return t=="country"?(i=e.country.name,s=r.country.name):t=="price_per_unit"?(i=e.price_per_unit,s=r.price_per_unit):t=="price"?(i=e.price_usd,s=r.price_usd):t=="msh_ratio"?(i=e.price_per_unit,s=r.price_per_unit):t=="incoterm"?(i=e.incoterm,s=r.incoterm):t=="pack_size"?(i=e.container.quantity,s=r.container.quantity):t=="volume"?(i=e.volume,s=r.volume):t=="start_date"&&(i=e.start_date,s=r.start_date),n?i>s?-1:s>i?1:0:i>s?1:s>i?-1:0},l=[{sort:"country",reverse:!1},{sort:"price_per_unit",reverse:!1},{sort:"price",reverse:!1},{sort:"msh_ratio",reverse:!1},{sort:"incoterm",reverse:!1},{sort:"pack_size",reverse:!1},{sort:"volume",reverse:!1},{sort:"start_date",reverse:!1}];for(i in l)l[i].append="",l[i].sort==t&&(l[i].reverse=!n,n?l[i].append="&#9660;":l[i].append="&#9650;");d3.select(o).select("#meddb_medicine_procurement").select("thead").selectAll("th").data(l).attr("cursor","pointer").html(function(e,t){return d3.select(this).html()+e.append}).on("click",function(t,n){meddb.medicine.detail(e,t.sort,t.reverse,!0)}),d3.select(o).select("#meddb_medicine_heading").text(u());var c=d3.select(o).select("#meddb_medicine_procurement").select("tbody").selectAll("tr").data(r.procurements.sort(f)).enter().append("tr");c.selectAll("td").data(a).enter().append("td").style("cursor","pointer").on("click",function(e,t){location.hash=e.hash}).text(function(e){return e.text});var h=function(e){var t=[];return t.push({text:e.product.name,hash:"product:"+e.product.id}),e.supplier&&e.supplier.name!=""?t.push({text:e.supplier.name,hash:"supplier:"+e.supplier.id}):t.push({text:"(Not Available)"}),e.product.manufacturer&&e.product.manufacturer.name!=""?t.push({text:e.product.manufacturer.name,hash:"manufacturer:"+e.product.manufacturer.id}):t.push({text:"(Not Available)"}),t.push({text:e.country.name}),t},c=d3.select(o).select("#meddb_medicine_product").select("tbody").selectAll("tr").data(r.procurements);c.enter().append("tr"),c.selectAll("td").data(h).enter().append("td").text(function(e){return e.text}).style("cursor",function(e){if(e.hash)return"pointer"}).on("click",function(e){e.hash&&(location.hash=e.hash)});var p=function(){var e={};r.procurements.forEach(function(t){label=t.country.name+" - "+render_pack(t),typeof e[label]=="undefined"&&(e[label]=[]),e[label].push({price:t.price_usd,packsize:t.container.quantity,volume:t.volume})}),v=[];for(country in e){var t={key:country},n=e[country];if(e[country]&&e[country].length>0){var i=0,s=0;for(index in n){var o=n[index];i+=o.price*o.volume,s+=o.volume*o.packsize}t.value=i/s}else t.value=0;v.push(t)}return v},d=function(e){var t=0,n=0,i=0;return e.forEach(function(e){e.value>0&&(t+=e.value,e.value>i&&(i=e.value),n++)}),d3.max([t*2/n,r.mshprice*1.1,i*1.1])},v=p(),m=d(v),g={width:940,height:v.length*25+20,node:d3.select(o).select("#meddb_medicine_prices")[0][0],bar:{height:25,margin:10,max:m,background:"#dfe7e5"},colors:["#08c","#08c","#08c","#08c","#08c","#08c","#08c","#08c"],data:v};r.mshprice&&(g.line={constant:r.mshprice,text:"MSH: $"+d3.round(r.mshprice,4)}),d3.select(o).select("#meddb_medicine_prices").html("");var y=new HorizontalBarGraph(g);s==1?meddb.template.replace(o):(meddb.history.add(location.hash,u()),meddb.template.show(o))})})},meddb.product={},meddb.product.detail=function(e){meddb.template.hide(),r("/product_detail.html",function(t){r("/json/product/"+e+"/",function(e){var n=function(){var t=[],n=[],r=[];return e.medicine.ingredients.forEach(function(e){n.push(e.inn),r.push(e.strength)}),t.push(n.join(" + ")),t.push(r.join(" + ")),t.push(e.medicine.dosageform.name||"(Not Available)"),e.manufacturer&&e.manufacturer.name!=""?t.push(e.manufacturer.name+" - "+e.manufacturer.country):t.push("(Not Available)"),t},r=function(e){var t=[];return t.push({text:e.country.name}),e.supplier&&e.supplier.name!=""?t.push({text:e.supplier.name,hash:"supplier:"+e.supplier.id}):t.push({text:"(Not Available)"}),t};d3.select(t).select("#meddb_product_heading").text(e.name),d3.select(t).select("table#meddb_product_detail").selectAll("td").data(n).text(function(e){return e});var i=d3.select(t).select("table#meddb_product_registration").select("tbody").selectAll("tr").data(e.procurements).enter().append("tr");i.selectAll("td").data(r).enter().append("td").text(function(e){return e.text}).style("cursor",function(e){if(e.hash)return"pointer"}).on("click",function(e){location.hash=e.hash}),meddb.history.add(location.hash,e.name),meddb.template.show(t)})})},meddb.procurement={},meddb.procurement.detail=function(e){meddb.template.hide(),r("/procurement_detail.html",function(t){r("/json/procurement/"+e+"/",function(e){var n=function(){var t=[];return e.product&&e.product.name?t.push({text:e.product.name,hash:"product:"+e.product.id}):t.push({text:"(Not Available)"}),t.push({text:e.container.quantity+" "+e.container.unit+" "+e.container.type}),t.push({text:e.volume+" (in packs of "+(e.packsize||"unknown size")+")"}),t.push({text:d3.round(e.price,2)+" "+e.currency.code}),t.push({text:e.incoterm.name||"(Not Available)"}),e.supplier&&e.supplier.name?t.push({text:e.supplier.name,hash:"supplier:"+e.supplier.id}):t.push({text:"(Not Available)"}),e.manufacturer&&e.manufacturer.name?t.push({text:e.manufacturer.name,hash:"manufacturer:"+e.manufacturer.id}):t.push({text:"(Not Available)"}),t.push({text:e.country.name||"(Not Available)"}),t.push({text:e.method||"(Not Available)"}),e.start_date&&e.end_date?t.push({text:e.start_date+" to "+e.end_date}):e.start_date?t.push({text:"From "+e.start_date}):e.end_date&&t.push({text:"Until "+e.end_date}),t};d3.select(t).select("table#meddb_procurement_detail").selectAll("td").data(n).text(function(e){return e.text}).style("cursor",function(e){if(e.hash)return"pointer"}).on("click",function(e){location.hash=e.hash}),meddb.history.add(location.hash,"Procurement "+e.id),meddb.template.show(t)})})},meddb.supplier={},meddb.supplier.detail=function(e){meddb.template.hide(),r("/supplier_detail.html",function(t){r("/json/supplier/"+e+"/",function(e){var n=function(e){var t=[];t.push({text:e.product.name,hash:"product:"+e.product.id}),t.push({text:e.country.name});var n=[];return e.product.medicine.ingredients.forEach(function(e){n.push(e.inn+" "+e.strength)}),t.push({text:n.join(", "),hash:"medicine:"+e.product.medicine.id}),t};d3.select(t).select("#meddb_supplier_heading").text(e.name);var r=function(){var t=[];return t.push(e.website||"None"),t.push(e.contact||"None"),t.push(e.email||"None"),t.push(e.altemail||"None"),t.push(e.phone||"None"),t.push(e.altphone||"None"),t.push(e.fax||"None"),t.push(e.address||"None"),t};d3.select(t).select("table#meddb_supplier_details").selectAll("td").data(r()).text(function(e){return e}),d3.select(t).select("table#meddb_supplier_details").select("td").data([e.website]).style("cursor","pointer").on("click",function(e){e&&(location=e)});var i=d3.select(t).select("table#meddb_supplier_registration").select("tbody").selectAll("tr").data(e.procurements).enter().append("tr");i.selectAll("td").data(n).enter().append("td").text(function(e){return e.text}).style("cursor",function(e){if(e.hash)return"pointer"}).on("click",function(e){location.hash=e.hash}),meddb.history.add(location.hash,e.name),meddb.template.show(t)})})},meddb.template.load("base.html",function(e){meddb.template.inject(e,"#meddb_container"),meddb.router()}),window.onhashchange=meddb.router})();